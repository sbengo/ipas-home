<div class="container">
  <!--INIT - stepper-->
  <mat-vertical-stepper [linear]="isLinear" #stepper>
    <!--INIT - stepper - firstStep -->

    <mat-step [stepControl]="productFormGroup" *ngIf="stepInfo.productStatus.hasDB === false">
      <form [formGroup]="productFormGroup">
        <ng-container>
          <ng-template matStepLabel>
            <h4>Platform requirements</h4>
          </ng-template>
          <mat-form-field>
            <input matInput placeholder="Product Name" formControlName="product" required>
          </mat-form-field>
          <mat-form-field>
            <input matInput placeholder="Models" formControlName="models" required>
          </mat-form-field>
          <mat-form-field>
            <textarea matInput placeholder="Description" formControlName="description" required> </textarea>
          </mat-form-field>
          <div>
            <button mat-raised-button color="accent" matStepperNext type="button">Next</button>
          </div>
        </ng-container>
      </form>
    </mat-step>
    <ng-container *ngIf="stepInfo.productStatus?.hasDB === true">

      <mat-step [stepControl]="productFormGroup">
        <form [formGroup]="productFormGroup">
          <ng-template matStepLabel>
            <h4>Product properties</h4>
            <p>Fill product properties</p>
          </ng-template>
          <h5>{{productFormGroup.value.product}}</h5>
          <br>
          <!--mat-form-field>
            <input matInput placeholder="Product Name" formControlName="product" required>
          </mat-form-field-->
          <mat-form-field>
            <input matInput placeholder="Models" formControlName="models" required>
          </mat-form-field>
          <mat-form-field>
            <textarea matInput placeholder="Description" formControlName="description" required> </textarea>
          </mat-form-field>
          <div>
            <button mat-raised-button color="accent" matStepperNext type="button">Next</button>
          </div>
        </form>
      </mat-step>


      <!--INIT - stepper - Gather -->
      <mat-step [stepControl]="productFormGroup">
        <form [formGroup]="productFormGroup">
          <ng-template matStepLabel>
            <h4>{{lengine.desc}} config</h4>
            <p>Create new {{lengine.id}} configs</p>
          </ng-template>
          <!--INIT - Engine selector to load all related params"-->
          <div class="col-md-3">
            <mat-form-field>
              <mat-select #engine_selection placeholder="Available engines" name="engine">
                <mat-option *ngFor="let engine of lengine.data" [value]="engine.type">
                  {{engine.name}}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-mini-fab color="primary" [disabled]="engine_selection.value == null" (click)="addEngine(lengine.id,engine_selection.value)">
              <mat-icon aria-label="Example icon-button with a heart icon">add</mat-icon>
            </button>
          </div>
          <!--INIT - Start the generation of the XXX section. Each engine can have multiple configs-->
          <div class="col-md-9" *ngIf="engine_selection !== 'external'">
            <ng-container *ngIf="productFormGroup.controls[lengine.id].controls.length > 0">
              <div [formArrayName]="lengine.id">
                <div class="col-md-12">
                  <!--Iterate over xxx controls and creates an row for each engine, declaring iengine as index -->
                  <div *ngFor="let sgather of productFormGroup.controls[lengine.id].controls; index as iengine">
                    <mat-accordion>
                      <div class="row">
                        <div class="col-md-10">
                          <h3>{{productFormGroup.controls[lengine.id].controls[iengine].value.engine}}</h3>
                        </div>
                        <!-- Actions available on engine section - create new config and delete engine config-->
                        <div class="col-md-2">
                          <!--Add new config engine based on step, engine index and engine name -->
                          <button mat-mini-fab color="primary" (click)="addConfigEngine(lengine.id,iengine, productFormGroup.controls[lengine.id].controls[iengine].value.engine)">
                            <mat-icon aria-label="Example icon-button with a heart icon">note_add</mat-icon>
                          </button>
                          <button mat-mini-fab color="primary" (click)="deleteEngine(lengine.id,iengine)">
                            <mat-icon aria-label="Example icon-button with a heart icon">delete_forever</mat-icon>
                          </button>
                        </div>
                      </div>
                      <!-- Enter on the engine form using iengine -->
                      <div [formArrayName]="iengine" class="row custom_row">
                        <!-- Enter on the config form for config control-->
                        <div formArrayName="config">
                          <!-- Iterates over each  configuration. Declares iconfig as index-->
                          <div *ngFor="let sgatherconfig of productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls; index as iconfig">
                            <!-- Enter on each config using iconfig"-->
                            <div class="col-md-9" [formArrayName]="iconfig">
                              <!--Form to complete 'Config Parameters' -->
                              <mat-expansion-panel>
                                <mat-expansion-panel-header>
                                  <mat-panel-title>
                                    <h3>{{iconfig}} - {{sgatherconfig.value.name || 'Name'}}</h3>
                                  </mat-panel-title>
                                </mat-expansion-panel-header>
                                <mat-divider></mat-divider>
                                <br>
                                <h3>Config</h3>
                                <br>
                                <h4>Product configuration:</h4>
                                <mat-form-field appearance="outline">
                                  <mat-label>Name:</mat-label>
                                  <input matInput formControlName="name">
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Models:</mat-label>
                                  <input matInput formControlName="models">
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Description:</mat-label>
                                  <input matInput formControlName="description">
                                </mat-form-field>
                                <!--mat-form-field appearance="outline">
                                <mat-label>Directory:</mat-label>
                                <input matInput formControlName="dir">
                              </mat-form-field-->
                                <div formGroupName="config" class="row custom_row">
                                  <h5>Files:
                                    <button mat-mini-fab color="primary" (click)="addConfig(lengine.id, iengine, iconfig)">
                                      <mat-icon aria-label="Example icon-button with a heart icon">add</mat-icon>
                                    </button>
                                  </h5>
                                  <ng-container *ngFor="let kk of productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.config.controls; index as n">
                                    <div [formArrayName]="n" class="col-md-12">
                                      <div style="margin-bottom: 20px" class="config-card">
                                        <button class="close-x" mat-icon-button (click)="removeConfig(lengine.id, iengine, iconfig, n)">
                                          <mat-icon aria-label="Example icon-button with a heart icon">delete</mat-icon>
                                        </button>
                                        <mat-form-field appearance="outline">
                                          <mat-label>Filename:</mat-label>
                                          <input #source matInput formControlName="source">
                                        </mat-form-field>
                                        <!--mat-form-field appearance="outline">
                                        <mat-label>Dest:</mat-label>
                                        <input matInput formControlName="dest">
                                      </mat-form-field-->
                                        <input id="singleFile" type="file" (change)="selectFile($event,lengine.id, iengine, iconfig, n)" />
                                      </div>
                                    </div>
                                  </ng-container>
                                </div>
                                <br>
                                <mat-divider></mat-divider>
                                <br>
                                <!--Form to complete 'Params' -->
                                <div formGroupName="params" class="row custom_row">
                                  <h3> Params:</h3>
                                  <br>
                                  <!--Form to complete 'Product Params' -->
                                  <div formArrayName="product_params" *ngIf="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params">
                                    <h5> Product Params:
                                      <button mat-mini-fab *ngIf="allowCustomParams === true" color="accent" (click)="openDialog(lengine.id,iengine,iconfig,'product_params')">
                                        <mat-icon>add</mat-icon>
                                      </button>
                                    </h5>
                                    <br>
                                    <!-- Iterates over each param. Declares ipp as index-->
                                    <!-- If its empty, the use can create them -->
                                    <ng-container *ngFor="let kk of productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params.controls; index as l">
                                      <!-- Enter on each product_params using ipp"-->
                                      <ng-container [formArrayName]="l">
                                        <ng-container *ngIf="kk.value.type === 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params.controls[l].value.key}}
                                            </mat-label>
                                            <mat-select formControlName="value">
                                              <mat-option *ngFor="let bool_param of bool_params" [value]="bool_param">
                                                {{bool_param}}
                                              </mat-option>
                                            </mat-select>
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                        <ng-container *ngIf="kk.value.type !== 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params.controls[l].value.key}}
                                            </mat-label>
                                            <input matInput [type]="kk.value.type === 'integer' ? 'number' : 'text'" formControlName="value">
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.product_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                      </ng-container>
                                    </ng-container>
                                  </div>
                                  <mat-divider></mat-divider>
                                  <br>
                                  <!--Form to complete 'Platform Params' -->
                                  <div formArrayName="platform_params" *ngIf="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params">
                                    <h5> Platform Params:
                                      <button mat-mini-fab *ngIf="allowCustomParams === true" color="accent" (click)="openDialog(lengine.id,iengine,iconfig,'platform_params')">
                                        <mat-icon>add</mat-icon>
                                      </button>
                                    </h5>
                                    <br>
                                    <ng-container *ngFor="let kk of productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params.controls; index as l">
                                      <ng-container [formArrayName]="l">
                                        <ng-container *ngIf="kk.value.type === 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params.controls[l].value.key}}
                                            </mat-label>
                                            <mat-select formControlName="value">
                                              <mat-option *ngFor="let bool_param of bool_params" [value]="bool_param">
                                                {{bool_param}}
                                              </mat-option>
                                            </mat-select>
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                        <ng-container *ngIf="kk.value.type !== 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline" style="padding-right: 30px !important;">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params.controls[l].value.key}}
                                            </mat-label>
                                            <input matInput [type]="kk.value.type === 'integer' ? 'number' : 'text'" formControlName="value">
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.platform_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                      </ng-container>
                                    </ng-container>
                                  </div>
                                  <mat-divider></mat-divider>
                                  <br>
                                  <div formArrayName="device_params" *ngIf="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params">
                                    <h5> Device Params:
                                      <button mat-mini-fab *ngIf="allowCustomParams === true" color="accent" (click)="openDialog(lengine.id,iengine,iconfig,'device_params')">
                                        <mat-icon>add</mat-icon>
                                      </button>
                                    </h5>
                                    <br>
                                    <ng-container *ngFor="let kk of productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params.controls; index as l">
                                      <ng-container [formArrayName]="l">
                                        <ng-container *ngIf="kk.value.type === 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params.controls[l].value.key}}
                                            </mat-label>
                                            <mat-select formControlName="value">
                                              <mat-option *ngFor="let bool_param of bool_params" [value]="bool_param">
                                                {{bool_param}}
                                              </mat-option>
                                            </mat-select>
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                        <ng-container *ngIf="kk.value.type !== 'boolean'">
                                          <mat-form-field [color]="'accent'" appearance="outline">
                                            <mat-label>{{productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params.controls[l].value.key}}
                                            </mat-label>
                                            <input matInput [type]="kk.value.type === 'integer' ? 'number' : 'text'" formControlName="value">
                                            <mat-icon matSuffix mat-mini-fab [matTooltip]="productFormGroup.controls[lengine.id].controls[iengine].controls.config.controls[iconfig].controls.params.controls.device_params.controls[l].value.description">help</mat-icon>
                                          </mat-form-field>
                                        </ng-container>
                                      </ng-container>
                                    </ng-container>
                                  </div>
                                </div>
                                <!-- end of Params Part-->
                              </mat-expansion-panel>
                            </div>
                            <div class="col-md-3">
                              <button mat-mini-fab (click)="deleteConfigEngine(lengine.id,iengine, iconfig)">
                                <mat-icon aria-label="Example icon-button with a heart icon">delete</mat-icon>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </mat-accordion>
                    <br>
                    <mat-divider> </mat-divider>
                    <br>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
          <div class="col-md-12">
            <button mat-raised-button color="accent" matStepperNext *ngIf="productFormGroup.controls[lengine.id].controls.length > 0">Finish {{lengine.desc}}</button>
            <button mat-raised-button color="accent" matStepperNext *ngIf="productFormGroup.controls[lengine.id].length == 0">Skip {{lengine.desc}}</button>
          </div>
        </form>
      </mat-step>
    </ng-container>
    <mat-step>
      <ng-template matStepLabel>
        <h4>Finish configuration</h4>
        <p>Finish and submit a new product</p>
      </ng-template>
      You are now done. Review your definition:
      <div>
        <button mat-raised-button color="accent" matStepperPrevious>Back</button>
        <button mat-raised-button color="accent">Cancel</button>
        <button mat-raised-button color="accent" (click)="createNewProduct()">Finish</button>
      </div>
    </mat-step>
  </mat-vertical-stepper>
  <br>
  <mat-divider></mat-divider>
  <br>
  <mat-slide-toggle [checked]="showDebug" (change)="showDebug === true ?  showDebug = false : showDebug = true">Debug Mode</mat-slide-toggle>
  <ng-container *ngIf="showDebug === true">
    <h4>Debug - Preview</h4>
    <pre>{{productFormGroup.value | json}}</pre>
    <h4>Files - Preview</h4>
    <pre>{{fileArray | json}}</pre>
  </ng-container>
</div>